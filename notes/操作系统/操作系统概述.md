# 操作系统概述

## 什么是操作系统

我们看以下的图片来观察计算机操作系统的结构：

![operating system](https://blog-1300663127.cos.ap-shanghai.myqcloud.com/BackEnd_Notes/operatingSystem.png)

最底层是硬件，往上是软件，大多数的计算机中 的操作（operating）有两种模式：内核态和用户态。**操作系统运行在内核态（kernel mode，也叫 supervisor mode），在内核态，有对于硬件的完全权限，并且可以执行任何机器可以执行的指令。剩下的软件运行在用户态，在这个模式只有一部分 机器指令是可用的，特别的，其中可以影响机器控制或者I/O操作的指令是不允许的。**



**shell 和 GUI 是最底层的用户态（user mode）软件**，很难给出操作系统的准确定义，操作系统是一种运行在内核态的软件，为应用程序员提供一个资源集的清晰抽象，并管理这些硬件。



### 作为扩展机器的操作系统

抽象是管理复杂性的一个关键，好的抽象可以把一个几乎不可能管理的任务划分为两个可管理的部分，其中第一个部分是有关抽象的定义和实现。第二部分是随时用这些抽象解决问题。



### 作为资源管理者的操作系统

我按照自底向上的观点，操作系统是用来管理一个复杂系统的各个部分，现代计算机包含处理器，存储器，始终，磁盘，鼠标，网络接口，打印机以及许多其他设备，从这个角度看，**操作系统的任务是在相互竞争的程序之间有序地控制对处理器，存储器以及其他I/O设备的分配。**



资源管理包括两种不同的多路复用（multiplexing）方法，时间上复用和空间上复用，当一种资源在时间上复用时，不同的程序或用户轮流使用它，显示第一个获得资源的使用，然后下一个，以此类推。例如 。在系统中只有一个CPU，而多个程序需要在该CPU上运行，操作系统则首先把该CPU分配给某个程序，在它运行了足够长的时间后，另一个程序得到CPU，然后时下个，最终，轮到第一个程序再次运行。至于资源时如何实现时间复用的，谁应该是下一个以及运行多长时间等则是操作系统的任务。关于时间复用的例子是打印机的共享，当多个打印作业在一台打印机上排队等待打印时，必须决定将轮到打印的是哪个作业。



另一类复用是空间复用，每个客户都得到资源的一部分，从而取代了客户排队。例如，通常在若干运行程序之间分割内存，这样每一个运行程序都可以同时入驻内存。在内存中同时存放若干个程序的效率，比把索引内存都分给一个程序的效率高得多。有关空间复用的其他资源还有磁盘，在许多操作系统中，一个磁盘同时为许多用户保存文件，分配磁盘空间并记录谁正在使用哪个磁盘块，是操作系统的典型任务。

## 操作系统的历史

第一台诊断的数字计算机是由英国数学家Charles Babbage设计的。

- 第一代（1945-1955）：真空管和穿孔卡片-ENIAC
- 第二代（1955-1965）：晶体管和批处理系统- IBM 1401, 7094
- 第三代（1965-1980）：集成电路和多道程序设计 - IBM System/360， OS/360和其他公司类似的第三代操作系统引入了mulitprograming（多道程序设计）。在7094机上，若当前作业因等待磁带或者其他I/O操作而暂停。CPU只能简单地踏步直至该I/O操作完成，对于I/O操作较多的数据处理，这样会造成昂贵的CPU时间的浪费。解决方案是哦将内存分为几个部分，每个部分存放不同的错也，当一个作业等待I/O操作完成时，另一个作业可以使用CPU。
- 第四代（1980-至今）个人计算机
- 第五代（1990-至今）移动计算机



x86的术语用来代表所有使用指令集体系结构的现代处理器，这类处理器的源头可以追溯到20世纪70年代的8086芯片。



曾参与MULTICS研制的贝尔实验室的计算机科学家Ken Thompson后来找到一台不忍使用的PDP-7机器，并开始开发一个简化的单用户版的MULTICS，他的工作导致了UNIX操作系统的诞生。UNIX主要有两个版本：AT&T的System V和加州伯克利大学分校的BSD，IEEE提出了一个UNIX的标准，称作POSIX，其定义了一个凡事UNIX必须支持的小型系统调用接口。



FreeBSD是一个院子Berkeley的BSD项目，也是一个流行的UNIX变体，左右现代Macintosh计算机都运行着FreeBSD的某一个修改版。它的衍生系统在移动设备上广泛地使用，例如哪些运行IOS7和安卓的设备。



## 计算机硬件简介

从概念上讲，一个简单的计算机可以抽象为如图的模型。所有的硬件都由一条系统总线链接起来并通过总线与其他设备通信。

![computer](https://blog-1300663127.cos.ap-shanghai.myqcloud.com/BackEnd_Notes/operating%20system/computer.png)

### CPU

CPU从内存中取出指令并执行，在每个CPU的基本周期中，首先从内存中取出指令，解码以确定其类型和操作数，接着执行它。然后取指(fetch)，解码(decode)并执行(execute)下一条指令，按照这个方式，程序被执行完成。

由于用来访问内存以得到指令或数据的时间要比执行指令话费的是哦见长的多，因此所有的CPU内都有一些用来保存关键变量和临时数据的**寄存器（register）**，这样，通常在指令集中提供一些指令，用以将一个字从内存掉入寄存器，以及将一个字从寄存器存入内存。

除了用来保存变量和临时结果通用寄存器（general register）以外，多数计算机还有一些**对程序员可见的专用寄存器，其中一个就是程序计数器（program counter），其中保存了将要去除的下一条指令的内存地址，在指令取出之后，程序计数器就被更新以便指向后继的指令。**

另一个寄存器是**堆栈指针（stack pointer）**，它指向内存中当前栈道顶端，该栈包含了每个执行过程的一个栈帧，**每个栈帧包含输入参数，局部变量，以及那些没有保存在寄存器中的临时变量。**

还有程序状态字（Program Status Word，PSW）寄存器，这个寄存器包含了条件码位（由比较指令设置）、CPU优先级、模式（用户态或内核态），以及其他的控制位。用户程序通常读入整个PSW，但只对其中少量字段写入。在系统调用和I/O中，PSW作用很重要。

> The operating system must be fully aware of all the registers. When time mul- tiplexing the CPU, the operating system will often stop the running program to (re)start another one. Every time it stops a running program, the operating system must save all the registers so they can be restored when the program runs later.

为了获取操作系统的服务，用户程序 必须通过系统调用（system call）以陷入内核并调用操作系统，`TRAP` 指令把用户态切换成内核态，并启动操作系统。



现代CPU一般会有两个缓存，第一个L1缓存在CPU内部 ，通常用来将已解码的指令掉入CPU的执行引擎。L2缓存用来存放进来使用过的若干兆字节的内存字，对L1缓存的访问不存在任何延迟，但对L2缓存的访问会延迟1到2个时钟周期。



### 存储器

在理想情况下，内存储器应该极为迅速（快于执行一条指令。这样CPU就 不用受到存储器的限制），充分大，并且非常便宜，但是目前的技术无法同时满足这三个目标，因此存储器采用了分层次的结构。

![memory](https://blog-1300663127.cos.ap-shanghai.myqcloud.com/BackEnd_Notes/operating%20system/memory.png)

在任何一个缓存系统中，都有若干需要尽快考虑的问题：

- 何时把一个新的内容放入缓存
- 把新内容放在缓存的哪一行上
- 在需要时，应该把哪个内容从缓存中移走
- 应该把新一走的内容放在某个较大存储器的何处

### I/O设备

I/O设备包括两个部分：设备控制器和设备本身。控制器时插在电路板上的一块芯片或者一组芯片，这块电路板物理地控制设备，它从操作系统接受命令，例如，从设备读数据，并且完成数据的处理。

标准化后的任何一个SATA磁盘控制器就可以适配任何一种SATA磁盘，ATA代表高级技术附件（AT Attachment），而SATA表示串行高级技术附件（Serial ATA）



每个设备控制器都有用于通讯的寄存器，要激活寄存器，设备驱动程序从操作系统获得一条命令，然后翻译成对应的值，并写进设备寄存器中。所有设备寄存器的集合构成了I/O端口空间（I/O port space）



### 总线

即插即用（plug and play）所做的工作时，系统自动地手机有关I/O设备的信息，集中赋予中断级别和I/O地址，然后通知每块卡所使用的数值，这项工作与计算机的启动密切相关。



### 启动计算机

每台计算机的主板上有一个BIOS（Basic Input Output System），其中有底层的I/O软件



## 操作系统大观园

### 大型机操作系统

用于大型机的操作系统主要面向多个作业的同时处理，多数这样的作业需要巨大(prodigious)的IO能力。系统主要提供三类服务：批处理，食物处理和分时，分时系统允许多个远程用户同时在计算机上运行作业，如在大型数据库上的查询。大型机操作系统的一个例子是OS/390(OS/360的后继版本)，但是大型机操作系统正在逐渐被注入Linux这类UNIX的变体替代。

### 服务器操作系统

服务器操作系统在服务器上运行，服务器可以是大型的个人计算机，工作站，甚至是大型机（mainframes），服务器可以提供打印服务，文件服务或者Web服务。典型的服务器操作系统有Solaris、FreeBSD、、Linux和Windows Server 201



### 多处理器操作系统

>  An increasingly common way to get major-league computing power is to con- nect multiple CPUs into a single system. Depending on precisely how they are connected and what is shared, these systems are called parallel computers, multi- computers, or multiprocessors. 



### 个人计算机操作系统

现在个人计算机操作系统都支持多道程序处理（multiprogramming），在启动时，通常有几十个程序开始运行。

### 掌上计算机操作系统

Android iOS



### 嵌入式操作系统

> all the software is in ROM. This means that there is no need for protection between applications, leading to design simplification. Systems such as Embedded Linux, QNX and VxWorks are popular in this domain.



### 传感器（Sensor Node）操作系统

> Each sensor node is a real computer, with a CPU, RAM, ROM, and one or more environmental sensors. It runs a small, but real operating system, usually one that is event driven, responding to external events or making measurements period- ically based on an internal clock. The operating system has to be small and simple because the nodes have little RAM and battery lifetime is a major issue. Also, as with embedded systems, all the programs are loaded in advance; users do not sud- denly start programs they downloaded from the Internet, which makes the design much simpler. TinyOS is a well-known operating system for a sensor node.

### 实时（Real-Time）操作系统

这类操作系统的特征是将时间作为关键参数。例如，在工业过程控制系统中，工厂中的实时计算机必须手机生成过程的数据并用有关数据控制机器。



### 智能卡操作系统

最小的操作系统运行在智能卡上。智能卡是一种包含一块CPU芯片的行用卡，它有非常严格的运行能耗和存储空间的限制。有些智能卡是面向Java的，这意味着在智能卡的ROM中有一个Java虚拟机解释器，有些卡可以同时处理多个Java小程序，并且需要对他们进行调度，这就是多道程序。



## 操作系统概念

### Files

进程和文件层次都可以组织成树状结构，但这两种树状结构有不同的地方。

- 进程的树状结构层次不深，很少超过三层，但是文件树状结构层次常常多达五层甚至更多。
- 进程的树状结构 是暂时的，通常最多存在几分钟，而文件树状结构可以存在数年之久。
- 只有父进程能访问子进程，而文件和目录通常存在一种机制，使文件所有者之外的其他用户页可以访问该文件。



在 UNIX 中，另一个重要的概念是特殊文件（special file）特殊问价你是为了使IO设备看起来像文件一般，这样，就像使用系统调用读写文件一样。有两种特殊文件：块特殊文件（block special file）和字符特殊文件（character special file）。特殊文件保存在 `/dev` 目录中，例如`/dev/lp` 是打印机.

最后一个特性与进程有关也与文件有关：管道（pipe），是一种虚文件（pseudofile），用来连接两个进程