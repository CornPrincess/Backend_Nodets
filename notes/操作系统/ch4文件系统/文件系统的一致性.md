# 文件系统的一致性 File-System Consistency

很多文件系统读取磁盘块，进行修改后再写回磁盘。**如果在修改过的磁盘全部写回之前系统崩溃，则文件系统很可能处于不一致的状态，如果一些未被写回的块是i节点、目录块或者是包含有空闲表的块时，这个额问题尤为严重。**

为了解决不一致（inconsistent）的问题，UNIX有 `fsck`，Windows有 `scandisk` 程序以检验文件系统的一致性，特别是崩溃之后的重新启动。**所有文件系统检验程序可以独立地检验每个文件系统（磁盘分区）的一致性**

一致性检查分为两种：块的一致性检查和文件的一致性检查。

## 块一致性

程序构造两张表，每张表中为每个块设立一个计数器，都初始化为0。第一个表的计数器跟踪该块在文件中出现的次数，数据从i节点中读出，第二个表的计数器跟踪该块在空闲表中的出现的次数，数据从空闲表中读出 。

- [ ] 补图

## 文件一致性

此时会用到一张计数器表，这时是一个文件对应于一个计数器，程序从根目录开始检验，沿着目录数递归下降，对于目录中的每个文件，将问价能使用计数器加1。当这个过程完成时，将每个文件对应计数器的数字与该文件i节点中的连接数目相比较。

在MS-DOS和某些系统上，文件的删除仅仅是在对应目录或i节点上设置某一位，表明文件被删除，并没有把磁盘块返回到空闲表中，所以如果用户发现误删还可以运行特定的程序进行恢复。

